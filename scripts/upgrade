#!/bin/bash

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression --message="Upgrading source files..."

ynh_setup_source --dest_dir="$install_dir" --full_replace=1  --keep="config.inc.php"

ynh_setup_source --dest_dir="$install_dir/lib/pkp" --source_id="pkp"
ynh_setup_source --dest_dir="$install_dir/plugins/generic/customBlockManager" --source_id="customBlockManager"
ynh_setup_source --dest_dir="$install_dir/plugins/generic/staticPages" --source_id="staticPages"
ynh_setup_source --dest_dir="$install_dir/plugins/generic/tinymce" --source_id="tinymce"
ynh_setup_source --dest_dir="$install_dir/plugins/generic/pdfJsViewer" --source_id="pdfJsViewer"
ynh_setup_source --dest_dir="$install_dir/docs/manual" --source_id="manual"
ynh_setup_source --dest_dir="$install_dir/plugins/generic/lensGalley" --source_id="lensGalley"
ynh_setup_source --dest_dir="$install_dir/plugins/generic/googleAnalytics" --source_id="googleAnalytics"
ynh_setup_source --dest_dir="$install_dir/plugins/blocks/makeSubmission" --source_id="makeSubmission"
ynh_setup_source --dest_dir="$install_dir/plugins/reports/reviewReport" --source_id="reviewReport"
ynh_setup_source --dest_dir="$install_dir/lib/ui-library" --source_id="ui-library"
ynh_setup_source --dest_dir="$install_dir/plugins/generic/citationStyleLanguage" --source_id="citationStyleLanguage"
ynh_setup_source --dest_dir="$install_dir/plugins/reports/counter/classes/COUNTER" --source_id="COUNTER"
ynh_setup_source --dest_dir="$install_dir/plugins/blocks/browse" --source_id="browse"
ynh_setup_source --dest_dir="$install_dir/plugins/generic/googleScholar" --source_id="googleScholar"
ynh_setup_source --dest_dir="$install_dir/plugins/generic/crossref" --source_id="crossref"
ynh_setup_source --dest_dir="$install_dir/plugins/generic/webFeed" --source_id="webFeed"

chown -R $app:www-data "$install_dir"

#=================================================
# REAPPLY SYSTEM CONFIGURATIONS
#=================================================
ynh_script_progression --message="Upgrading system configurations related to $app..."

ynh_add_fpm_config

ynh_add_nginx_config

ynh_use_logrotate --non-append

ynh_add_fail2ban_config --logpath="/var/log/nginx/${domain}-error.log" --failregex=""

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression --message="Upgrade of $app completed" --last
